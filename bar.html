<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> React </title>
</head>

<body>
  <script>
    function createDatasets(data) {
      const { labels, datasets } = data
      if (!labels || !labels.key || !labels.values || labels.values.length == 0 || !datasets) return null;

      const colorArray = ['rgba(255, 99, 132, 0.5)', 'rgba(53, 162, 235, 0.5)', 'rgba(255, 99, 132, 0.5)', 'rgba(53, 162, 235, 0.5)', 'rgba(255, 99, 132, 0.5)', 'rgba(53, 162, 235, 0.5)']
      const result = {
        labels: labels.values,
        datasets: datasets.map(({ key, values, label }, index) => ({
          data: values,
          label,
          backgroundColor: colorArray[index],
          key,
          id: key

        }))
      }

      return result
    }

    async function fetchDefaults() {
      const defaultValues = {
        data: [ 
          [ 'Date', 'Revenue (Millions)', 'Confidence' ],
          [ 1998, 31, 17 ],
          [ 1999, 34, 15 ],
          [ 2000, 14, 14 ],
          [ 2001, 16, 14 ],
          [ 2002, 21, 16 ],
          [ 2003, 26, 14 ],
          [ 2004, 25, 13 ],
          [ 2005, 29, 14 ],
          [ 2006, 33, 18 ],
          [ 2007, 32, 20 ],
          [ 2008, 18, 21 ],
          [ 2009, 21, 20 ],
          [ 2010, 23, 20 ],
          [ 2011, 29, 20 ],
          [ 2021, 45, 24 ]
        ],
        chartType: 'bar', 
        legend: {
          display: 'true',
          position: 'top'
        },
        title: {
          color: 'rgba(143, 149, 136, 1)', 
          display: 'true',
          font: {
            family: 'Lora',
            size: '18',
            style: 'none',
            weight: 'bold',
          },
          text: 'Rev Test'
        },
        // xAxis dataset 
        defaultXAxis: {
          min: "0",
          max: "100",
          stacked: false, 
          ticks: {
            color: 'rgba(126, 147, 100, 1)'
          },
          title: {
            color: 'rgba(126, 147, 100, 1)',
            display: true,
            text: 'Date',
            fontSize: '12'
          }
        },
        // yAxis dataset 
        defaultYAxis: {
          min: "0",
          max: "100",
          stacked: false, 
          ticks: {
            color: 'rgba(143, 149, 136, 1)'
          },
          title: {
            color: 'rgba(143, 149, 136, 1)',
            display: true,
            text: '',
            fontSize: '12'
          }
        },
        // emphasis annotation 
        emphasisAnnotation: {
          darken:'#D3D3D3',
          dataIndex: 3,
          enabled: false, 
          seriesName:'Confidence',
          highlight: 'rgb(60, 167, 236)',
        },
        // arrow annotation 
        arrowAnnotation: {
          color: 'rgba(143, 149, 136, 1)',
          doubleArrow: '1',
          enabled: false, 
          endDataIndex: 2,
          endDatasetKey: '',
          id: 'arrowTemp',
          startDataIndex: 0,
          startDatasetKey: '',
          label: "Arrow label",
          lineType: 'global',
          type: 'arrow',
        },
        defaultColors: ['rgba(135, 214, 116, 0.5)','rgba(39, 174, 239, 0.5)','rgba(179, 61, 198, 0.5)', ]
        // green,blue,purpls
      }

      window.ColbyChartInfo = {
        ...window.ColbyChartInfo,
        defaultValues, 
      }

      console.log('colby init succesfully!', window.ColbyChartInfo) 

    }

    function rotateSheetData(sheetData) {
    const data = []
    const rLen = sheetData.length
    const cLen = sheetData[0].length

    for (let c = 0; c < cLen; c++) {
        const row = []

        for (let r = 0; r < rLen; r++) {
            row.push(sheetData[r][c])
        }

        data.push(row)
    }

    const result = {
        colCount: data.length,
        header: data.map((r, index) => r[0] ? r[0] : `Column #${index + 1}`),
        cols: data.map(r => r.slice(1))
    }
    return result
}

    async function fetchData() {
      return new Promise(res => setTimeout(res, 3000))
    }

    async function fetchDataRange(range) {
      console.log('[fetchDataRange]', !!range)
      window.ColbyChartInfo = {
        ...window.ColbyChartInfo,
        loadingStatus: 'loading'
      }
      await fetchData()
      const data = [['Date',
        'Q1 FY2013',
        'Q2 FY2013',
        'Q3 FY2013',
        'Q4 FY2013',
        'Q1 FY2014',
        'Q2 FY2014',
        'Q3 FY2014',
        'Q4 FY2014',
        'Q1 FY2015',
        'Q2 FY2015',
        'Q3 FY2015',
        'Q4 FY2015'],
      ['Online Sales',
        '237',
        '492',
        '625',
        '1239',
        '1686',
        '1728',
        '1716',
        '1839',
        '4543',
        '4630',
        '4890',
        '7405'],
      ['Offline Sales',
        '5208',
        '5094',
        '5907',
        '6063',
        '5499',
        '5670',
        '5571',
        '6165',
        '6346',
        '6382',
        '5719',
        '4442']
      ]

      const rawDatasets = {
        colCount: data.length,
        header: data.map((r, index) => r[0] ? r[0] : `Column #${index + 1}`),
        cols: data.map(r => r.slice(1))
      }

      window.ColbyChartInfo = {
        ...window.ColbyChartInfo,
        rawDatasets,
        loadingStatus: 'loaded'
      }

    }

    async function init() {
      const testKey = await (() => { console.log('init'); return 'bar' })();
      window.ColbyChartInfo = {
        chartType: 'bar',
        createDatasets,
        rotateSheetData, 
        storageKey: `appState-${testKey}`,
        loadingStatus: 'none',
        fetchDataRange,
        fetchDefaults,
      }
      window.onInsertImage = function (data) {
        console.log('[onInsertImage] window', data)
        const test = data
        return true;
      }

      
    }
    window.colbyInit = init

  </script>
  <div id="root"></div>
  <script type="module" src="/src/main.jsx"></script>
</body>

</html>